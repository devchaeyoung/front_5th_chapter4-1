name: Light House CI
on:
  push:
    branches:
      - main
permissions:          # ğŸ‘ˆ ì¶”ê°€
  contents: write     # README ì»¤ë°‹Â·í‘¸ì‹œìš©
  pull-requests: write  # (PR ìë™ ìƒì„± í”Œë¡œìš°ê°€ í•„ìš”í•  ë•Œ)
    
jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci

      - name: Generate lighthouserc.json
        run: |
          cat > lighthouserc.json <<'EOF'
          {
            "ci": {
              "collect": {
                "url": [
                  "http://hanghae-front-5th-chaeyoung.s3-website.ap-northeast-2.amazonaws.com/",
                  "https://dlxgp5it7mnux.cloudfront.net/",
                  "https://devforworld.com/"
                ]
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0.8}],
                  "categories:accessibility": ["warn", {"minScore": 0.9}],
                  "is-crawlable": "off",
                  "unused-javascript": ["warn", {"maxLength": 2}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq bc # bcëŠ” Bashì—ì„œ ë¶€ë™ì†Œìˆ˜ ê³„ì‚°í•  ë•Œ ì‚¬ìš©

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: false
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Build Lighthouse summary table
        id: make_table
        run: |
          DATE=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M')
          FILE=$(ls -t .lighthouseci/*.report.json | head -1)   # ìµœì‹  ê²°ê³¼ í•œ ê°œ

          PERF=$(jq -r '.categories.performance.score * 100' "$FILE")
          ACC=$(jq -r '.categories.accessibility.score * 100' "$FILE")
          SEO=$(jq -r '.categories.seo.score * 100' "$FILE")

          {
            echo "## ğŸ“ˆ Lighthouse ë¦¬í¬íŠ¸"
            echo "_(ì—…ë°ì´íŠ¸: $DATE KST)_"
            echo ""
            echo "| í•­ëª© | ì ìˆ˜ |"
            echo "|------|------|"
            echo "| Performance | $PERF |"
            echo "| Accessibility | $ACC |"
            echo "| SEO | $SEO |"
          } > lhci-summary.md

      # â‘¡ README ì¤‘ê°„ì— í‘œ ì‚½ì…(ì£¼ì„ ì‚¬ì´ë§Œ êµì²´)
      - name: Inject summary into README.md
        if: steps.make_table.outputs.noReport != 'true'
        run: |
          awk -f - README.md <<'AWK' > README.tmp
          BEGIN{skip=0}
          /<!-- LHCI-TABLE-START -->/ {print; system("cat lhci-summary.md"); skip=1; next}
          /<!-- LHCI-TABLE-END -->/   {print; skip=0; next}
          !skip
          AWK
          mv README.tmp README.md

      - name: Cleanup .Lighthouseci
        run: |
          rm -rf .lighthouseci

      - name: Show git changes
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          echo "=== git status ==="
          git status -s
          echo "=== diff stat ==="
          git diff --stat || true

      # â‘¢ ë³€ê²½ì‚¬í•­ ìë™ ì»¤ë°‹Â·í‘¸ì‹œ
      - name: Commit & push if README changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: ì—…ë°ì´íŠ¸ Lighthouse ë¦¬í¬íŠ¸"
          branch: main
          file_pattern: README.md